<div class="js-router--dashboard dashboard">
    <div class="d-grid">
        <div class="d-row">
            <div id="dashboard-sortable" class="dashboard__container">
                {% for block in enabledBlocks %}
                    {% if block.enabled %}
                        {% set index = loop.index0 %}
                        <div id="{{ block.postData.block }}-{{ index }}"
                             class="dashboard__block dashboard__block--{{ block.type }}"
                             data-block="{{ block.postData.block }}"
                             data-type="{{ block.type }}"
                             data-action="{{ block.registeredActions | join(',') }}">
                            <div class="dashboard__content">
                                <button class="dashboard__remove js-remove-block"
                                        data-block="{{ block.postData.block }}-{{ index }}"></button>
                                <div class="dashboard__title">{{ block.postData.block }}</div>
                                <div class="dashboard__image">
                                    {% if block.hasImage %}
                                        <img src="{{ block.image }}"
                                             class="dashboard__image">
                                    {% else %}
                                        <img src="{{ block.templatePath }}static/images/dashboard-placeholder/{{ block.postData.block }}-placeholder.jpg"
                                             class="dashboard__image">
                                    {% endif %}
                                </div>
                                <div class="dashboard__info">
                                    <div class="dashboard__infoBlock">
                                        <label class="dashboard__label">{{ translate('_type', 'dashboard') }}</label>
                                        <div class="dashboard__select">
                                            <select class="form-control js-type-block"
                                                    data-block="{{ block.postData.block }}-{{ index }}">
                                                {% for type in block.availableTypes %}
                                                    <option value="{{ type }}"{% if block.type == type %} selected{% endif %}>{{ type }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                    </div>
                                    {% if block.registeredActions | length %}
                                    <div class="dashboard__infoBlock">
                                        <div class="dashboard__label">{{ translate('_enabledActions', 'dashboard') }}</div>
                                        <div class="dashboard__infoContainer">
                                            <div class="dashboard__el">
                                                {% for action in block.enabledActions %}
                                                    <label><input name="registeredAction[{{ loop.index0 }}]"
                                                                  type="checkbox" value="{{ action }}"
                                                                  {% if action in block.registeredActions %}checked{% endif %} />{{ action }}
                                                    </label>
                                                {% endfor %}
                                            </div>
                                        </div>
                                    </div>
                                    {% endif %}

                                    {% for form in block.form %}
                                        {% include 'formtype/form-' ~ form.type ~ '.html.twig' %}
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    {% endif %}
                {% endfor %}
            </div>
            <div class="dashboard__actions">
                <div class="dashboard__add">
                    <div class="dashboard__select dashboard__select--block">
                        <select class="form-control js-select-block">
                            <option value="" selected>Seleziona blocco</option>
                            {% for block in installedBlocks %}
                                <option value="{{ block.postData.block }}"
                                        data-type="{{ block.availableTypes|json_encode() }}"
                                        data-action="{{ block.registeredActions|json_encode() }}"
                                        data-form="{{ block.form|json_encode() }}">
                                    {{ block.postData.block }}

                                </option>
                            {% endfor %}
                        </select>
                        <div class="dashboard__error">Campo Obbligatorio</div>
                    </div>
                    <div class="dashboard__select dashboard__select--type">
                        <select class="form-control js-select-type"></select>
                    </div>
                    <button class="btn btn-primary dahsboard__button--add js-add-block">AGGIUNGI NUOVO</button>
                </div>
                <button class="button btn btn-danger dahsboard__button--save js-save-block">SALVA CONFIGURAZIONE
                </button>
                <div class="dashboard__message dashboard__ok">La nuova configurazione è stata salvata.</div>
                <div class="dashboard__message dashboard__ko">Si è verificato un errore. Ti chiediamo di riprovare.
                </div>
            </div>
        </div>
    </div>
</div>

<script type="application/javascript">

    $(function () {
        const dashboardSortable = $("#dashboard-sortable");
        const selectBlock = $('.js-select-block');
        const selectType = $('.js-select-type');
        const selectAction = $('.js-select-action');
        const addBlock = $('.js-add-block');
        const saveField = $('.js-save-block');
        const blockAction = $('.dashboard__actions');
        const blockActionWidth = blockAction.width();
        const windowWidth = $(window).width();
        const elementOffset = blockAction.offset();
        const elementOffsetTop = 108;
        const elementOffsetLeft = elementOffset.left;
        const templatePath = "{{ templatePath }}";

        if (windowWidth >= 1024) {
            $(window).scroll(function () {
                anchorSidebar();
            });
        }

        initSortable();
        uploadFileCheck();

        // SALVATAGGIO DATI
        saveField.click(function () {
            let response = {};
            const blocks = $('.dashboard__block');

            if (blocks) {
                for (i = 0; i < blocks.length; i++) {
                    const block = blocks[i].getAttribute('data-block');
                    const type = blocks[i].getAttribute('data-type');
                    const action = blocks[i].getAttribute('data-action').split(',');
                    const firstInsert = blocks[i].getAttribute('data-first-insert');
                    const extraElement = blocks[i].querySelectorAll('.js-extra-setting');
                    let extraSettings = {};

                    response[i] = {
                        'block': block,
                        'settings': {
                            'position': i + 1,
                            'type': type,
                            'enabled': true,
                            'enabledActions': action,
                            'data': {
                                'firstInsert': firstInsert
                            }
                        }
                    }

                    if (extraElement.length) {

                        for (let i = 0; i < extraElement.length; i++) {
                            const key = extraElement[i].getAttribute('name');
                            const value = extraElement[i].value;
                            const typeEl = extraElement[i].getAttribute('type');

                            switch (typeEl) {
                                case 'checkbox':
                                    if (extraElement[i].checked) {
                                        if (extraSettings[key]) {
                                            extraSettings[key] += '|' + value;
                                        } else {
                                            extraSettings[key] = value;
                                        }
                                    }
                                    break;
                                case 'radio':
                                    if (extraElement[i].checked) {
                                        extraSettings[key] = value;
                                    }
                                    break;
                                case 'file':
                                case 'image':
                                    const fileUrl = extraElement[i].getAttribute('data-url');
                                    if (fileUrl) {
                                        extraSettings[key] = fileUrl;
                                    }
                                    break;
                                default:
                                    if (value) {
                                        extraSettings[key] = value;
                                    }
                            }

                        }

                        response[i]['settings']['data'] = {...response[i]['settings']['data'], ...extraSettings};
                        console.log(response[i]['settings']['data']);
                    }

                }
            }

            $.ajax({
                url: '{{ ajaxUrl }}',
                type: 'POST',
                data: {
                    settings: response
                },
                beforeSend: () => {
                    saveField.attr('disabled', true);
                    $('.dashboard__message').css('display', 'none');
                },
                success: () => {
                    console.log(response);
                    saveField.removeAttr('disabled');
                    $('.dashboard__ok').css('display', 'block');
                },
                error: err => {
                    console.log(err)
                    $('.dashboard__ko').css('display', 'block');
                }
            })

        });

        // MOSTRA TYPES IN BASE AL BLOCCO SCELTO
        selectBlock.change(function () {
            const types = $(this).children('option:selected').attr('data-type');
            const actions = $(this).children('option:selected').attr('data-action');
            selectType.find('option').remove();
            selectAction.find('label').remove();
            selectType.parent('.dashboard__select').fadeOut();
            selectAction.parent('.dashboard__select').fadeOut();

            if (JSON.parse(types).length) {
                const typesJSON = JSON.parse(types);
                selectBlock.parent('.dashboard__select').removeClass('is-required');
                selectType.parent('.dashboard__select').fadeIn();

                for (i = 0; i < typesJSON.length; i++) {
                    selectType.append('<option value="' + typesJSON[i] + '">' + typesJSON[i] + '</option>')
                }
            } else {
                selectType.parent('.dashboard__select').fadeOut();
            }
        });

        // AGGIUNGE BLOCCO
        addBlock.click(function () {
            const selectBlockValue = selectBlock.children('option:selected').val();
            const selectTypeValue = selectType.children('option:selected').val();
            const countBlocks = $('.dashboard__block').length + 2;

            if (selectBlockValue.length > 0) {
                selectBlock.parent('.dashboard__select').removeClass('is-required');

                const newBlock = '<div id="' + selectBlockValue + '-' + countBlocks + '" class="dashboard__block dashboard__block--' + selectTypeValue + '"' +
                    '            data-type="' + selectTypeValue + '" data-block="' + selectBlockValue + '" data-action="" data-first-insert="true">\n' +
                    '            <div class="dashboard__content">\n' +
                    '              <button class="dashboard__remove js-remove-block" data-block="' + selectBlockValue + '-' + countBlocks + '"></button>\n' +
                    '              <img src="' + templatePath + '/static/images/dashboard-placeholder/' + selectBlockValue + '-placeholder.jpg" class="dashboard__image">' +
                    '              <div class="dashboard__info">' +
                    '              <div class="dashboard__title">' + selectBlockValue + '</div>\n' +
                    '              </div>' +
                    '            </div>\n' +
                    '          </div>';

                dashboardSortable.append(newBlock);
                initSortable(true);
                $('html, body').animate({
                    scrollTop: $('#' + selectBlockValue + '-' + countBlocks).offset().top
                }, 1000);
            } else {
                selectBlock.parent('.dashboard__select').addClass('is-required');
            }
        });

        // RIMUOVE BLOCCO
        $(document).on('click', '.js-remove-block', function () {
            const blockToRemove = $(this).attr('data-block');
            $('#' + blockToRemove).remove();
            initSortable(true);
        });

        // MODIFICA DIMENSIONE BLOCCO
        $(document).on('change', '.js-type-block', function () {
            const blockToChange = $(this).attr('data-block');
            const newType = $(this).val();
            $('#' + blockToChange).removeAttr('class').addClass('dashboard__block').addClass('dashboard__block--' + newType).attr('data-type', newType);
            initSortable(true);
        });

        function initSortable(reinit) {
            if (reinit) {
                dashboardSortable.sortable('destroy');
                dashboardSortable.unbind();
            }
            dashboardSortable.sortable({
                connectWith: "#dashboard-sortable"
            });
        }

        function anchorSidebar() {
            const $scrollTop = $(window).scrollTop();
            const $distance = (elementOffsetTop - $scrollTop);

            if ($distance <= 0) {
                blockAction.addClass('is-fixed');
                blockAction.css('width', blockActionWidth);
                blockAction.css('left', elementOffsetLeft);
                blockAction.css('top', 0);
            } else {
                blockAction.removeClass('is-fixed');
                blockAction.removeAttr('style');
            }
        }

        function uploadFileCheck() {
            const inputFile = document.querySelectorAll('.js-upload-file');

            for (let i = 0; i < inputFile.length; i++) {
                const item = inputFile[i];
                item.addEventListener('change', () => {
                    const formData = new FormData();
                    formData.append('file', item.files[0], item.files[0].name);

                    if (item.classList.contains('form-control-image')) {

                        const error = item.parentNode.parentNode.querySelector('.dashboard__error');
                        error.style.display = 'none';

                        if (isFileImage(item.files[0]) > 0) {
                            uploadFileAjax(formData, item)
                        } else {
                            error.style.display = 'block';
                        }
                    } else {
                        uploadFileAjax(formData, item);
                    }

                })
            }

        }

        function uploadFileAjax(formData, item) {
            $.ajax({
                url: '{{ ajaxUploadFileUrl }}',
                data: formData,
                processData: false,
                contentType: false,
                type: 'POST',
                success: function(url){
                    //console.log(url);
                    console.log(url);
                    let imageUrl = 'http://testimage.local'; // PLEASE REMOVE, ONLY FOR TEST
                    item.setAttribute('data-url', imageUrl);
                }
            });
        }

        function isFileImage(file) {
            const acceptedImageTypes = ['image/gif', 'image/jpeg', 'image/png'];
            return file && $.inArray(file['type'], acceptedImageTypes)
        }

    });
</script>

<style type="text/css">
    .dashboard .d-row {
        align-items: flex-start;
        justify-content: space-between;
        flex-direction: column-reverse;
    }

    @media all and (min-width: 1024px) {
        .dashboard .d-row {
            flex-direction: row;
        }
    }

    .dashboard__select__title {
        margin-bottom: 5px;
    }

    .dashboard__info {
        width: calc(100% - 20px);
        position: relative;
        bottom: 10px;
        left: 10px;
    }

    .dashboard__title {
        display: block;
        width: 100%;
        text-align: center;
        font-size: 12px;
        font-weight: bold;
        margin-bottom: 10px;
        word-break: break-all;
    }

    .dashboard__image {
        display: block;
        width: 100%;
        text-align: center;
        font-size: 12px;
        font-weight: bold;
        margin-bottom: 15px;
        word-break: break-all;
    }

    .dashboard__input {
        display: block;
        width: 100%;
        text-align: center;
        font-size: 12px;
        font-weight: bold;
        margin-bottom: 10px;
        word-break: break-all;
    }

    .dashboard__select {
        display: block;
        width: 100%;
        text-align: center;
        font-size: 12px;
        font-weight: bold;
        margin-bottom: 15px;
        word-break: break-all;
    }

    .dashboard__infoBlock {
        padding: 15px 15px 0 15px;
        border: 1px solid #ccc;
        margin-bottom: 15px;
        background-color: #efefef;
    }

    .dashboard__infoBlock .dashboard__error {
        text-align: center;
        margin-top: 5px;
    }

    .dashboard__helper {
        font-size: 12px;
        margin-top: 10px;
        text-align: center;
        color: #666;
        font-style: italic;
    }

    .dashboard__checkbox {
        display: block;
        width: 100%;
        text-align: center;
        font-size: 12px;
        font-weight: bold;
        margin-bottom: 10px;
        word-break: break-all;
    }

    .dashboard__label {
        margin-bottom: 10px;
        text-transform: uppercase;
        display: block;
        text-align: center;
        font-weight: 800;
    }

    .dashboard__infoContainer {
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .dashboard__el {
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 10px;
        margin-left: 10px;
    }


    .dashboard__el input[type=checkbox],
    .dashboard__el input[type=radio] {
        margin: 0 5px 0 0;
    }

    .dashboard__title--sources {
        margin-top: 10px;
    }

    .dashboard__container {
        background: #e2e1e0;
        display: flex;
        flex-wrap: wrap;
        width: 100%;
        padding: 10px;
    }

    @media all and (min-width: 1024px) {

        .dashboard__container {
            width: 74%;
        }
    }

    .dashboard__block {
        padding: 5px;
        box-sizing: border-box;
        flex-basis: 100%;
    }

    .dashboard__content {
        background-color: #fff;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12), 0 1px 2px rgba(0, 0, 0, 0.24);
        transition: all 0.3s cubic-bezier(.25, .8, .25, 1);
        height: 100%;
        position: relative;
        padding: 25px 10px 125px 10px;
        cursor: grab;
    }

    .dashboard__message {
        padding: 10px;
        text-align: center;
        margin-top: 10px;
        display: none;
    }

    .dashboard__ok {
        color: #155724;
        background-color: #d4edda;
        border-color: #c3e6cb;
    }

    .dashboard__ko {
        color: #721c24;
        background-color: #f8d7da;
        border-color: #f5c6cb;
    }

    .dashboard__image {
        max-width: 100%;
        height: auto;
    }

    .dashboard__content:focus {
        cursor: grabbing;
    }

    .dashboard__content:hover {
        box-shadow: 0 14px 28px rgba(0, 0, 0, 0.25), 0 10px 10px rgba(0, 0, 0, 0.22);
    }

    .dashboard__remove {
        position: absolute;
        top: 5px;
        right: 5px;
        font-size: 16px;
        background-color: transparent;
        border: 0;
        width: 15px;
        height: 15px;
        background-image: url('../templates/standard/static/images/icons/user-panel/icon--up-close.png');
        background-size: cover;
    }

    .dashboard__remove:hover {
        background-image: url('../templates/standard/static/images/icons/user-panel/icon--up-close-hover.png');
    }

    .dashboard__actions {
        width: 100%;
        display: flex;
        justify-content: flex-end;
        flex-direction: column;
    }

    @media all and (min-width: 1024px) {
        .dashboard__actions {
            width: 25%;
        }

        .dashboard__actions.is-fixed {
            position: fixed;
            right: 0;
        }
    }

    .dashboard__select.is-required select {
        border: 1px solid #ff0000;
    }

    .dashboard__select.is-required .dashboard__error {
        display: block;
    }

    .dashboard__error {
        display: none;
        color: #ff0000;
    }

    .dashboard__add {
        display: flex;
        flex-direction: column;
        padding: 20px;
        background-color: #efefef;
        border: 1px solid #ccc;
        border-radius: 4px;
        margin-bottom: 40px;
    }

    .dashboard__add .dashboard__select {
        margin-bottom: 20px;
    }

    @media all and (min-width: 1024px) {

        .dashboard__block--4-col {
            flex-basis: 100%;
        }

        .dashboard__block--3-col {
            flex-basis: 75%;
        }

        .dashboard__block--2-col {
            flex-basis: 50%;
        }

        .dashboard__block--1-col {
            flex-basis: 25%;
        }

    }

    .dashboard__select--type,
    .dashboard__select--action {
        display: none;
    }

</style>
