<style>

    .add-classroom-dates .col-box-end-button {
        display: flex;
        align-items: flex-end;
    }

    .add-classroom-dates .col-box-end-button .box-classroom {

        align-items: center;
        margin-right: 15px;
    }

    .add-classroom-dates .btn {
        border-radius: 8px;
    }

    .add-classroom-dates .btn-save {
        background: #2D8CFF;
        color: white;
    }

    .add-classroom-dates .btn-delete {
        background: transparent;
        color: #2D8CFF;
    }

    .add-classroom-dates .select-box {
        margin-left: 5px;
    }


</style>


<div class="std_block">
    <div class="container">
        {% set courseUrl = 'index.php?r=' ~ courseBaseLink ~ '/show' %}

        {% set classUrl = 'index.php?r=' ~ classroomBaseLink ~ '/classroom&id_course=' ~ idCourse %}


        {% set title = Lang_translate('_MOD_DATES', 'course') ~ ': ' ~ postData.name %}

        {% if postdata.dateBegin is not empty %}
            {% set title = title ~ ' (' ~ postData.dateBegin ~ ')' %}
        {% endif %}

        {{ Get_title(
            {
                (courseUrl) : Lang_translate('_COURSE', 'course'),
                (classUrl) : Lang_translate('_CLASSROOM', 'course'),
                '': title
            },false) }}

        {% if error %}
            {% set errorTranslate = Lang_translate((error), 'course') %}
            {{ UiFeedback_error(errorTranslate) }}
        {% endif %}

        {{ Form_openForm('date', action ) }}
        {{ Form_openElementSpace() }}


        <div class="edit-classroom-dates">

            <div id="js-row-hidden" class="hidden">
                <!--<tr data-date="#day_date#" data-date_begin="#dataset_day_date_begin#" data-date_end="#dataset_day_date_end#" data-pause_begin="#dataset_day_pause_begin#" data-pause_end="#dataset_day_pause_end#" data-classroom="#dataset_day_classroom#">
                    <th scope="row">#day_date#</th>
                    <td>#day_date_begin#</td>
                    <td>#day_date_end#</td>
                    <td>#day_pause_begin#</td>
                    <td>#day_pause_end#</td>
                    <td>#day_classroom#</td>
                    <td><a class="js-edit" href="javascript:void(0)" >Edit</a></td>
                    <td><a class="js-delete" href="javascript:void(0)" >Delete</a></td>
                </tr>-->
            </div>

            <table class="table">
                <thead>
                <tr>
                    <th scope="col">Date</th>
                    <th scope="col">Ora inizio</th>
                    <th scope="col">Ora fine</th>
                    <th scope="col">Ora inizio pausa</th>
                    <th scope="col">Ora fine pausa</th>
                    <th scope="col">Classe</th>
                </tr>
                </thead>
                <tbody id="js-table-body">
                {% for day in postData.days %}

                    <tr data-date="{{ day.date }}" data-date_begin="{{ day.date_begin }}"
                        data-date_end="{{ day.date_end }}" data-pause_begin="{{ day.pause_begin }}"
                        data-pause_end="{{ day.pause_end }}" data-classroom="{{ day.classroom }}">
                        <th scope="row">{{ day.date }}</th>
                        <td>{{ day.date_begin|date("H:i") }}</td>
                        <td>{{ day.date_end|date("H:i") }}</td>
                        <td>{{ day.pause_begin|date("H:i") }}</td>
                        <td>{{ day.pause_end|date("H:i") }}</td>
                        <td>{{ day.classroom }}</td>
                        <td><a class="js-edit" href="javascript:void(0)">Edit</a></td>
                        <td><a class="js-delete" href="javascript:void(0)">Delete</a></td>
                    </tr>
                {% endfor %}

                </tbody>
            </table>
        </div>


        <div class="add-classroom-dates">
            <div class="row mb-4">
                <div class="col">
                    <div class="form-outline">
                        <label for="form-day_date">Date</label>
                        <input class="form-control" id="form-day_date" type="date">
                    </div>
                </div>
                <div class="col">
                    <div class="form-outline">
                        <label class="form-label" for="form-day_date_begin">Ora inizio</label>
                        <input type="time" id="form-day_date_begin" class="form-control"/>
                    </div>
                </div>
                <div class="col">
                    <div class="form-outline">
                        <label class="form-label" for="form-day_date_end">Ora fine</label>
                        <input type="time" id="form-day_date_end" class="form-control"/>
                    </div>
                </div>
                <div class="col">
                    <div class="form-outline">
                        <label class="form-label" for="form-day_pause_begin">Ora inizio pausa</label>
                        <input type="time" id="form-day_pause_begin" class="form-control"/>
                    </div>
                </div>
                <div class="col">
                    <div class="form-outline">
                        <label class="form-label" for="form-day_pause_end">Ora inizio pausa</label>
                        <input type="time" id="form-day_pause_end" class="form-control"/>
                    </div>
                </div>
                <div class="col col-box-end-button">
                    <div class="form-outline box-classroom">
                        <label for="form-day_classroom">Classrom</label>
                        <select class="form-control select-box" id="form-day_classroom">
                            <option>1</option>
                            <option>2</option>
                        </select>
                    </div>
                    <div class="form-outline">
                        <button class="btn btn-save" id="js-classroom-dates-save">Save</button>
                        <button class="btn btn-delete">Delete</button>
                    </div>
                </div>
            </div>
        </div>


        {{ Form_closeElementSpace() }}
        {{ Form_openButtonSpace() }}
        {{ Form_getButton('save', 'save', Lang_translate('_SAVE', 'course')) }}
        {{ Form_getButton('undo', 'undo', Lang_translate('_UNDO', 'course')) }}
        {{ Form_closeElementSpace() }}
        {{ Form_closeForm() }}
    </div>

</div>


<script type="text/javascript">

    var jsEdit = document.getElementsByClassName('js-edit');
    var jsDelete = document.getElementsByClassName('js-delete');

    for (let item of jsEdit) {
        item.addEventListener('click', editRow)
    }
    ;

    for (let item of jsDelete) {
        item.addEventListener('click', deleteRow)
    }
    ;

    function editRow(e) {
        e.preventDefault()
        var rowData = rowDataset(e)
        /** 01-07-2021*/
        var date = stringToDate(rowData.date,'dd-MM-yyyy','-');
        date.setHours( date.getHours() + 2 );

        document.getElementById('form-day_date').valueAsDate = date;

        var date = rowData.date_begin.split(" ");
        document.getElementById('form-day_date_begin').value = date[1];
        date = rowData.date_end.split(" ");
        document.getElementById('form-day_date_end').value = date[1];
        date = rowData.pause_begin.split(" ");
        document.getElementById('form-day_pause_begin').value = date[1];
        date = rowData.pause_end.split(" ");
        document.getElementById('form-day_pause_end').value = date[1];
        document.getElementById('form-day_classroom');
    };

    function deleteRow(e) {
        e.preventDefault()
        e.target.parentNode.parentNode.remove();
    };

    function rowDataset(e) {
        var row = e.target.parentNode.parentNode
        return row.dataset;
    };


    var jsClassroomSave = document.getElementById('js-classroom-dates-save');

    jsClassroomSave.addEventListener('click', function (e) {
        e.preventDefault();
        var date = document.getElementById('form-day_date');
        var dateBegin = document.getElementById('form-day_date_begin');
        var dateEnd = document.getElementById('form-day_date_end');
        var pauseBegin = document.getElementById('form-day_pause_begin');
        var pauseEnd = document.getElementById('form-day_pause_end');
        var classroom = document.getElementById('form-day_classroom');
        var newTableRow = document.getElementById('js-row-hidden').innerHTML;

        if (!date.value == '' && !dateBegin.value == '' && !dateEnd.value == '' && !pauseBegin.value == '' && !pauseEnd.value == '' && !classroom.value == '') {
            newTableRow = newTableRow.replace('<!--', '').replace('-->', '');
            newTableRow = newTableRow.replaceAll('#day_date#', formattedDate(new Date(date.value)));
            newTableRow = newTableRow.replace('#day_date_begin#', dateBegin.value).replace('#dataset_day_date_begin#', date.value + ' ' + dateBegin.value);
            newTableRow = newTableRow.replace('#day_date_end#', dateEnd.value).replace('#dataset_day_date_end#', date.value + ' ' + dateEnd.value);
            newTableRow = newTableRow.replace('#day_pause_begin#', pauseBegin.value).replace('#dataset_day_pause_begin#', date.value + ' ' + pauseBegin.value);
            newTableRow = newTableRow.replace('#day_pause_end#', pauseEnd.value).replace('#dataset_day_pause_end#', date.value + ' ' + pauseEnd.value);
            newTableRow = newTableRow.replace('#day_classroom#', classroom.value).replace('#dataset_day_classroom#', classroom.value);

            var tableBody = document.getElementById("js-table-body");
            tableBody.insertAdjacentHTML('beforeend', newTableRow);

            var lastRow = tableBody.rows.item(tableBody.rows.length - 1);

            var jsEdit = lastRow.getElementsByClassName('js-edit');
            var jsDelete = lastRow.getElementsByClassName('js-delete');

            for (let item of jsEdit) {
                item.addEventListener('click', editRow)

            }
            ;

            for (let item of jsDelete) {
                item.addEventListener('click', deleteRow)
            }
            ;

        } else {
            alert('devi inserire tutti i valori')
        }

    })

    function formattedDate(d = new Date) {
        let month = String(d.getMonth() + 1);
        let day = String(d.getDate());
        const year = String(d.getFullYear());

        if (month.length < 2) month = '0' + month;
        if (day.length < 2) day = '0' + day;

        return `${day}-${month}-${year}`;
    }

    function stringToDate(_date,_format,_delimiter)
    {
        var formatLowerCase=_format.toLowerCase();
        var formatItems=formatLowerCase.split(_delimiter);
        var dateItems=_date.split(_delimiter);
        var monthIndex=formatItems.indexOf("mm");
        var dayIndex=formatItems.indexOf("dd");
        var yearIndex=formatItems.indexOf("yyyy");
        var month=parseInt(dateItems[monthIndex]);
        month-=1;
        return new Date(dateItems[yearIndex],month,dateItems[dayIndex]);
    }

</script>
